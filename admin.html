<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Austin Industrial HVAC Admin Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f6f8; margin: 0; }
    header {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px 30px;
      background-color: white;
      border-bottom: 2px solid #e31937;
      margin-bottom: 20px;
    }
    header img {
      height: 60px;
    }
    header span {
      font-weight: 700;
      font-size: 2rem;
      color: #e31937;
      font-family: Arial, sans-serif;
    }
    h1 { text-align: center; color: #003366; margin-bottom: 0; }
    #dashboard { display: none; }
    .chart-container {
      width: 600px;
      margin: 40px auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #adminPrompt {
      max-width: 400px;
      margin: 100px auto;
      padding: 30px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0,0,0,0.15);
      text-align: center;
    }
    #adminPrompt input {
      font-size: 18px;
      padding: 10px;
      width: 80%;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #adminPrompt button {
      font-size: 18px;
      padding: 10px 30px;
      background: #e31937;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #adminPrompt button:hover {
      background: #b7152b;
    }
    #errorMsg {
      color: red;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<header>
  <img 
    src="https://www.austin-ind.com/wp-content/themes/austinind2018/assets/images/austin-industries-logo.svg" 
    alt="Austin Industries Logo" 
  />
  <span>HVAC</span>
</header>

<h1>Austin Industrial HVAC Admin Dashboard</h1>

<div id="adminPrompt">
  <p>Please enter the admin code to view the dashboard:</p>
  <input type="password" id="adminCode" placeholder="Admin Code" />
  <br />
  <button onclick="checkAdminCode()">Enter</button>
  <p id="errorMsg"></p>
</div>

<div id="dashboard">
  <div class="chart-container">
    <canvas id="chartUnit"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="chartProblems"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="chartArea"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="chartFilter"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="chartBelt"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="chartTechnician"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="chartRefrigerant"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="chartOthers"></canvas>
  </div>
</div>

<script>
const ADMIN_CODE = '1695';

function checkAdminCode() {
  const input = document.getElementById('adminCode').value.trim();
  const errorMsg = document.getElementById('errorMsg');
  if (input === ADMIN_CODE) {
    errorMsg.textContent = '';
    document.getElementById('adminPrompt').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    loadAndRenderCharts();
  } else {
    errorMsg.textContent = 'Incorrect admin code. Please try again.';
  }
}

const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/1FAIpQLSdXGdxxaYBUo6AKEHISx8ncDKw89-cgB-5jZVJQXEvWxdyf5g/pub?output=csv';

function loadAndRenderCharts() {
  fetch(SHEET_CSV_URL)
    .then(res => res.text())
    .then(csvText => {
      const data = parseCSV(csvText);
      renderCharts(data);
    })
    .catch(() => {
      alert('Failed to load data from the sheet.');
    });
}

function parseCSV(text) {
  const lines = text.trim().split('\n');
  const headers = lines[0].split(',');
  return lines.slice(1).map(line => {
    const values = parseCSVLine(line);
    const row = {};
    headers.forEach((h, i) => row[h] = values[i] || "");
    return row;
  });
}

function parseCSVLine(line) {
  const result = [];
  let current = '';
  let insideQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    if (char === '"' && line[i + 1] === '"') {
      current += '"';
      i++;
    } else if (char === '"') {
      insideQuotes = !insideQuotes;
    } else if (char === ',' && !insideQuotes) {
      result.push(current);
      current = '';
    } else {
      current += char;
    }
  }
  result.push(current);
  return result;
}

function countValues(data, column) {
  const counts = {};
  data.forEach(row => {
    const val = row[column]?.trim() || "Unknown";
    counts[val] = (counts[val] || 0) + 1;
  });
  return counts;
}

function createBarChart(counts, ctx, title) {
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Object.keys(counts),
      datasets: [{
        label: title,
        data: Object.values(counts),
        backgroundColor: 'rgba(227, 25, 55, 0.7)'
      }]
    },
    options: {
      responsive: true,
      plugins: { title: { display: true, text: title }},
      scales: { y: { beginAtZero: true }}
    }
  });
}

function createPieChart(counts, ctx, title) {
  const colors = [
    'rgba(227, 25, 55, 0.7)',
    'rgba(227, 100, 100, 0.7)',
    'rgba(255, 159, 164, 0.7)',
    'rgba(201, 50, 75, 0.7)',
    'rgba(255, 99, 132, 0.7)',
    'rgba(255, 205, 210, 0.7)'
  ];
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: Object.keys(counts),
      datasets: [{
        label: title,
        data: Object.values(counts),
        backgroundColor: colors
      }]
    },
    options: { responsive: true, plugins: { title: { display: true, text: title }} }
  });
}

function renderCharts(data) {
  createBarChart(countValues(data, "Unit #"), document.getElementById('chartUnit'), 'Checks Per Unit #');

  createPieChart(countValues(data, "What problem/s did the unit have (select all that apply)"), document.getElementById('chartProblems'), 'Reported Problems');

  createBarChart(countValues(data, "What area is the unit in?"), document.getElementById('chartArea'), 'Maintenance by Area');

  createPieChart(countValues(data, "Does the filter need replacing?"), document.getElementById('chartFilter'), 'Filter Replacement Needed');

  createBarChart(countValues(data, "Was the belt in good condition? (write observations/concerns in other)"), document.getElementById('chartBelt'), 'Belt Condition');

  createBarChart(countValues(data, "Name of technitian"), document.getElementById('chartTechnician'), 'Technician Activity');

  createPieChart(countValues(data, "What refrigerant was used (only answer if unit needed refrigerant)"), document.getElementById('chartRefrigerant'), 'Refrigerant Used');

  const exclude = [
    "Unit #",
    "What problem/s did the unit have (select all that apply)",
    "What area is the unit in?",
    "Does the filter need replacing?",
    "Was the belt in good condition? (write observations/concerns in other)",
    "Name of technitian",
    "What refrigerant was used (only answer if unit needed refrigerant)"
  ];

  const allHeaders = Object.keys(data[0] || {});

  const otherHeaders = allHeaders.filter(h => !
